def propertyFiles = ['build.properties']

def allDependencies = [
    'android4.jar'
]

projectLibsDir = new File(rootProject.projectDir, 'lib')

configurations {
    loadPropertiesFromFiles(propertyFiles)
    project.version = buildVersion
}

allprojects {
    version = buildVersion
}

task wrapper(type: Wrapper) {
    gradleVersion = '1.0-milestone-7'
}

task build (dependsOn: 'downloadLibs')

task downloadLibs << {
    println 'Downloading libraries...'
    projectLibsDir.mkdirs()
    allDependencies.each { library ->
        def libFile = new File(projectLibsDir, library)
        if (!libFile.exists()) {
            def libUrl = remoteRepoSitoryUrl + library
            println 'Downloading ' + library + ' to ' + libFile + ' from ' + libUrl
            def tempFile = new File(projectLibsDir, library + '.temp')
            ant.get(src: libUrl, dest: tempFile.path, verbose:true)
            tempFile.renameTo(libFile)
        } else {
            println 'Skip downloading ' + library + '. It has already exist in local repository'
        }
    }
}


task eclipse(dependsOn: 'clearEclipse')

task clearEclipse << {
    def eclipseArtifacts = ['.classpath', '.project']
    project.subprojects.each { subproject ->
        subproject.tasks.matching {task -> task.name == 'eclipse'}.all { task ->
            eclipseArtifacts.each { artifact ->
                new File(subproject.projectDir, artifact).delete()
            }
        }
    }
}

def loadPropertiesFromFiles(List files) {
    files.each { propertyFileName ->
        def propertyFile = new File(rootProject.projectDir, propertyFileName)
        if(propertyFile.exists()) { 
            propertyFile.withReader { reader ->
                def props = new Properties()
                props.load(reader)
                props.each { property ->
                    project.setProperty(property.key, property.value)
                }
            }
        } else {
            println 'File not found ' + propertyFile
        }
    }
}